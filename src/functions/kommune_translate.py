import math
import os

import dapla as dp
import pandas as pd
import pyjstat
import requests
from dapla import FileClient
from dapla.auth import AuthClient
from pyjstat import pyjstat
import math

fs = FileClient.get_gcs_file_system()


def translate_kommune_kodes(df):


    merged_kommunes = {
        "0101": ["3001"],
        "0104": ["3002"],
        "0105": ["3003"],
        "0106": ["3004"],
        "0111": ["3011"],
        "0118": ["3012"],
        "0119": ["3013"],
        "0121": ["3026"],
        "0122": ["3014"],
        "0123": ["3014"],
        "0124": ["3014"],
        "0125": ["3014"],
        "0127": ["3015"],
        "0128": ["3016"],
        "0135": ["3017"],
        "0136": ["3002"],
        "0137": ["3018"],
        "0138": ["3014"],
        "0211": ["3019"],
        "0213": ["3020"],
        "0214": ["3021"],
        "0215": ["3022"],
        "0216": ["3023"],
        "0217": ["3020"],
        "0219": ["3024"],
        "0220": ["3025"],
        "0221": ["3026"],
        "0226": ["3030"],
        "0227": ["3030"],
        "0228": ["3027"],
        "0229": ["3028"],
        "0230": ["3029"],
        "0231": ["3030"],
        "0233": ["3031"],
        "0234": ["3032"],
        "0235": ["3033"],
        "0236": ["3034"],
        "0237": ["3035"],
        "0238": ["3036"],
        "0239": ["3037"],
        "0402": ["3401"],
        "0403": ["3403"],
        "0412": ["3411"],
        "0415": ["3412"],
        "0417": ["3413"],
        "0418": ["3414"],
        "0419": ["3415"],
        "0420": ["3416"],
        "0423": ["3417"],
        "0425": ["3418"],
        "0426": ["3419"],
        "0427": ["3420"],
        "0428": ["3421"],
        "0429": ["3422"],
        "0430": ["3423"],
        "0432": ["3424"],
        "0434": ["3425"],
        "0436": ["3426"],
        "0437": ["3427"],
        "0438": ["3428"],
        "0439": ["3429"],
        "0441": ["3430"],
        "0501": ["3405"],
        "0502": ["3407"],
        "0511": ["3431"],
        "0512": ["3432"],
        "0513": ["3433"],
        "0514": ["3434"],
        "0515": ["3435"],
        "0516": ["3436"],
        "0517": ["3437"],
        "0519": ["3438"],
        "0520": ["3439"],
        "0521": ["3440"],
        "0522": ["3441"],
        "0528": ["3442"],
        "0529": ["3443"],
        "0532": ["3053"],
        "0533": ["3054"],
        "0534": ["3446"],
        "0536": ["3447"],
        "0538": ["3448"],
        "0540": ["3449"],
        "0541": ["3450"],
        "0542": ["3451"],
        "0543": ["3452"],
        "0544": ["3453"],
        "0545": ["3454"],
        "0602": ["3005"],
        "0604": ["3006"],
        "0605": ["3007"],
        "0612": ["3038"],
        "0615": ["3039"],
        "0616": ["3040"],
        "0617": ["3041"],
        "0618": ["3042"],
        "0619": ["3043"],
        "0620": ["3044"],
        "0621": ["3045"],
        "0622": ["3046"],
        "0623": ["3047"],
        "0624": ["3048"],
        "0625": ["3005"],
        "0626": ["3049"],
        "0627": ["3025"],
        "0628": ["3025"],
        "0631": ["3050"],
        "0632": ["3051"],
        "0633": ["3052"],
        "0701": ["3801"],
        "0704": ["3803"],
        "0710": ["3804"],
        "0711": ["3005"],
        "0712": ["3805"],
        "0713": ["3802"],
        "0715": ["3802"],
        "0716": ["3803"],
        "0729": ["3811"],
        "0805": ["3806"],
        "0806": ["3807"],
        "0807": ["3808"],
        "0811": ["3812"],
        "0814": ["3813"],
        "0815": ["3814"],
        "0817": ["3815"],
        "0819": ["3816"],
        "0821": ["3817"],
        "0822": ["3817"],
        "0826": ["3818"],
        "0827": ["3819"],
        "0828": ["3820"],
        "0829": ["3821"],
        "0830": ["3822"],
        "0831": ["3823"],
        "0833": ["3824"],
        "0834": ["3825"],
        "0901": ["4201"],
        "0904": ["4202"],
        "0906": ["4203"],
        "0911": ["4211"],
        "0912": ["4212"],
        "0914": ["4213"],
        "0919": ["4214"],
        "0926": ["4215"],
        "0928": ["4216"],
        "0929": ["4217"],
        "0935": ["4218"],
        "0937": ["4219"],
        "0938": ["4220"],
        "0940": ["4221"],
        "0941": ["4222"],
        "1001": ["4204"],
        "1002": ["4205"],
        "1003": ["4206"],
        "1004": ["4207"],
        "1014": ["4223"],
        "1017": ["4204"],
        "1018": ["4204"],
        "1021": ["4205"],
        "1026": ["4224"],
        "1027": ["4225"],
        "1029": ["4205"],
        "1032": ["4225"],
        "1034": ["4226"],
        "1037": ["4227"],
        "1046": ["4228"],
        "1102": ["1108"],
        "1103": ["1103"],
        "1129": ["1108"],
        "1141": ["1103"],
        "1142": ["1103"],
        "1201": ["4601"],
        "1211": ["4611"],
        "1216": ["4612"],
        "1219": ["4613"],
        "1221": ["4614"],
        "1222": ["4615"],
        "1223": ["4616"],
        "1224": ["4617"],
        "1227": ["4618"],
        "1228": ["4618"],
        "1231": ["4618"],
        "1232": ["4619"],
        "1233": ["4620"],
        "1234": ["4621"],
        "1235": ["4621"],
        "1238": ["4622"],
        "1241": ["4624"],
        "1242": ["4623"],
        "1243": ["4624"],
        "1244": ["4625"],
        "1245": ["4626"],
        "1246": ["4626"],
        "1247": ["4627"],
        "1251": ["4628"],
        "1252": ["4629"],
        "1253": ["4630"],
        "1256": ["4631"],
        "1259": ["4626"],
        "1260": ["4631"],
        "1263": ["4631"],
        "1264": ["4632"],
        "1265": ["4633"],
        "1266": ["4634"],
        "1401": ["4602"],
        "1411": ["4635"],
        "1412": ["4636"],
        "1413": ["4637"],
        "1416": ["4638"],
        "1417": ["4639"],
        "1418": ["4640"],
        "1419": ["4640"],
        "1420": ["4640"],
        "1421": ["4641"],
        "1422": ["4642"],
        "1424": ["4643"],
        "1426": ["4644"],
        "1428": ["4645"],
        "1429": ["4646"],
        "1430": ["4647"],
        "1431": ["4647"],
        "1432": ["4647"],
        "1433": ["4647"],
        "1438": ["4648"],
        "1439": ["4602"],
        "1441": ["4649"],
        "1443": ["4649"],
        "1444": ["1577"],
        "1445": ["4650"],
        "1449": ["4651"],
        "1502": ["1506"],
        "1504": ["1507"],
        "1514": ["1514"],
        "1519": ["1577"],
        "1523": ["1507"],
        "1524": ["1578"],
        "1526": ["1578"],
        "1529": ["1507"],
        "1534": ["1507"],
        "1543": ["1506"],
        "1545": ["1506"],
        "1546": ["1507"],
        "1548": ["1579"],
        "1551": ["1579"],
        "1571": ["5055"],
        "1805": ["1806"],
        "1826": ["1826"],
        "1849": ["1875"],
        "1852": ["5412"],
        "1853": ["1853"],
        "1854": ["1806"],
        "1867": ["1867"],
        "1902": ["5401"],
        "1903": ["5402"],
        "1911": ["5411"],
        "1913": ["5412"],
        "1917": ["5413"],
        "1919": ["5414"],
        "1920": ["5415"],
        "1922": ["5416"],
        "1923": ["5417"],
        "1924": ["5418"],
        "1925": ["5419"],
        "1926": ["5420"],
        "1927": ["5421"],
        "1928": ["5421"],
        "1929": ["5421"],
        "1931": ["5421"],
        "1933": ["5422"],
        "1936": ["5423"],
        "1938": ["5424"],
        "1939": ["5425"],
        "1940": ["5426"],
        "1941": ["5427"],
        "1942": ["5428"],
        "1943": ["5429"],
        "2002": ["5404"],
        "2003": ["5405"],
        "2004": ["5406"],
        "2011": ["5430"],
        "2012": ["5403"],
        "2014": ["5432"],
        "2015": ["5433"],
        "2017": ["5406"],
        "2018": ["5434"],
        "2019": ["5435"],
        "2020": ["5436"],
        "2021": ["5437"],
        "2022": ["5438"],
        "2023": ["5439"],
        "2024": ["5440"],
        "2025": ["5441"],
        "2027": ["5442"],
        "2028": ["5443"],
        "2030": ["5444"],
        "5001": ["5001"],
        "5004": ["5006"],
        "5005": ["5007"],
        "5011": ["5055"],
        "5013": ["5056"],
        "5015": ["5057"],
        "5016": ["5059"],
        "5017": ["5057"],
        "5018": ["5058"],
        "5019": ["5058"],
        "5023": ["5059"],
        "5024": ["5059"],
        "5025": ["5025"],
        "5030": ["5001"],
        "5039": ["5006"],
        "5040": ["5007"],
        "5048": ["5007"],
        "5050": ["5060"],
        "5051": ["5060"],
        "1850": ["1806", "1875"],
        "5012": ["5055", "5056", "5059"],
    }

    # Iterate over each 'kommune_nr' value in the DataFrame

    df_test = df.copy()

    appended_rows = []

    # Iterate over each 'kommune_nr' value in the DataFrame
    for index, row in df_test.iterrows():
        kommune_nr = row["kommune_nr"]
        if kommune_nr in merged_kommunes:
            translated_values = merged_kommunes[kommune_nr]
            value = row["value"]
            num_translations = len(translated_values)
            if num_translations == 1:
                # If there's only one translation, replace 'kommune_nr' directly
                df_test.at[index, "kommune_nr"] = translated_values[0]
            else:
                # If there are multiple translations, distribute the value evenly
                value_per_translation = math.ceil(value / num_translations)
                for translation in translated_values:
                    appended_rows.append(
                        {"kommune_nr": translation, "value": value_per_translation}
                    )

    # Append the rows to the DataFrame
    new_df = pd.concat([df_test, pd.DataFrame(appended_rows)], ignore_index=True)

    # # Ensure new_kommune_nr is hashable by converting to string (if needed)
    # new_df['new_kommune_nr'] = new_df['new_kommune_nr'].apply(lambda x: str(x) if isinstance(x, list) else x)

    # Aggregate values for merged kommunes
    df_aggregated = new_df.groupby("kommune_nr", as_index=False).agg({"value": "sum"})

    # return the final dataframe
    return df_aggregated


def translate_kommune_kodes_2(df):
    
    merged_kommunes = {
        "0101": ["3001"],
        "0104": ["3002"],
        "0105": ["3003"],
        "0106": ["3004"],
        "0111": ["3011"],
        "0118": ["3012"],
        "0119": ["3013"],
        "0121": ["3026"],
        "0122": ["3014"],
        "0123": ["3014"],
        "0124": ["3014"],
        "0125": ["3014"],
        "0127": ["3015"],
        "0128": ["3016"],
        "0135": ["3017"],
        "0136": ["3002"],
        "0137": ["3018"],
        "0138": ["3014"],
        "0211": ["3019"],
        "0213": ["3020"],
        "0214": ["3021"],
        "0215": ["3022"],
        "0216": ["3023"],
        "0217": ["3020"],
        "0219": ["3024"],
        "0220": ["3025"],
        "0221": ["3026"],
        "0226": ["3030"],
        "0227": ["3030"],
        "0228": ["3027"],
        "0229": ["3028"],
        "0230": ["3029"],
        "0231": ["3030"],
        "0233": ["3031"],
        "0234": ["3032"],
        "0235": ["3033"],
        "0236": ["3034"],
        "0237": ["3035"],
        "0238": ["3036"],
        "0239": ["3037"],
        "0402": ["3401"],
        "0403": ["3403"],
        "0412": ["3411"],
        "0415": ["3412"],
        "0417": ["3413"],
        "0418": ["3414"],
        "0419": ["3415"],
        "0420": ["3416"],
        "0423": ["3417"],
        "0425": ["3418"],
        "0426": ["3419"],
        "0427": ["3420"],
        "0428": ["3421"],
        "0429": ["3422"],
        "0430": ["3423"],
        "0432": ["3424"],
        "0434": ["3425"],
        "0436": ["3426"],
        "0437": ["3427"],
        "0438": ["3428"],
        "0439": ["3429"],
        "0441": ["3430"],
        "0501": ["3405"],
        "0502": ["3407"],
        "0511": ["3431"],
        "0512": ["3432"],
        "0513": ["3433"],
        "0514": ["3434"],
        "0515": ["3435"],
        "0516": ["3436"],
        "0517": ["3437"],
        "0519": ["3438"],
        "0520": ["3439"],
        "0521": ["3440"],
        "0522": ["3441"],
        "0528": ["3442"],
        "0529": ["3443"],
        "0532": ["3053"],
        "0533": ["3054"],
        "0534": ["3446"],
        "0536": ["3447"],
        "0538": ["3448"],
        "0540": ["3449"],
        "0541": ["3450"],
        "0542": ["3451"],
        "0543": ["3452"],
        "0544": ["3453"],
        "0545": ["3454"],
        "0602": ["3005"],
        "0604": ["3006"],
        "0605": ["3007"],
        "0612": ["3038"],
        "0615": ["3039"],
        "0616": ["3040"],
        "0617": ["3041"],
        "0618": ["3042"],
        "0619": ["3043"],
        "0620": ["3044"],
        "0621": ["3045"],
        "0622": ["3046"],
        "0623": ["3047"],
        "0624": ["3048"],
        "0625": ["3005"],
        "0626": ["3049"],
        "0627": ["3025"],
        "0628": ["3025"],
        "0631": ["3050"],
        "0632": ["3051"],
        "0633": ["3052"],
        "0701": ["3801"],
        "0704": ["3803"],
        "0710": ["3804"],
        "0711": ["3005"],
        "0712": ["3805"],
        "0713": ["3802"],
        "0715": ["3802"],
        "0716": ["3803"],
        "0729": ["3811"],
        "0805": ["3806"],
        "0806": ["3807"],
        "0807": ["3808"],
        "0811": ["3812"],
        "0814": ["3813"],
        "0815": ["3814"],
        "0817": ["3815"],
        "0819": ["3816"],
        "0821": ["3817"],
        "0822": ["3817"],
        "0826": ["3818"],
        "0827": ["3819"],
        "0828": ["3820"],
        "0829": ["3821"],
        "0830": ["3822"],
        "0831": ["3823"],
        "0833": ["3824"],
        "0834": ["3825"],
        "0901": ["4201"],
        "0904": ["4202"],
        "0906": ["4203"],
        "0911": ["4211"],
        "0912": ["4212"],
        "0914": ["4213"],
        "0919": ["4214"],
        "0926": ["4215"],
        "0928": ["4216"],
        "0929": ["4217"],
        "0935": ["4218"],
        "0937": ["4219"],
        "0938": ["4220"],
        "0940": ["4221"],
        "0941": ["4222"],
        "1001": ["4204"],
        "1002": ["4205"],
        "1003": ["4206"],
        "1004": ["4207"],
        "1014": ["4223"],
        "1017": ["4204"],
        "1018": ["4204"],
        "1021": ["4205"],
        "1026": ["4224"],
        "1027": ["4225"],
        "1029": ["4205"],
        "1032": ["4225"],
        "1034": ["4226"],
        "1037": ["4227"],
        "1046": ["4228"],
        "1102": ["1108"],
        "1103": ["1103"],
        "1129": ["1108"],
        "1141": ["1103"],
        "1142": ["1103"],
        "1201": ["4601"],
        "1211": ["4611"],
        "1216": ["4612"],
        "1219": ["4613"],
        "1221": ["4614"],
        "1222": ["4615"],
        "1223": ["4616"],
        "1224": ["4617"],
        "1227": ["4618"],
        "1228": ["4618"],
        "1231": ["4618"],
        "1232": ["4619"],
        "1233": ["4620"],
        "1234": ["4621"],
        "1235": ["4621"],
        "1238": ["4622"],
        "1241": ["4624"],
        "1242": ["4623"],
        "1243": ["4624"],
        "1244": ["4625"],
        "1245": ["4626"],
        "1246": ["4626"],
        "1247": ["4627"],
        "1251": ["4628"],
        "1252": ["4629"],
        "1253": ["4630"],
        "1256": ["4631"],
        "1259": ["4626"],
        "1260": ["4631"],
        "1263": ["4631"],
        "1264": ["4632"],
        "1265": ["4633"],
        "1266": ["4634"],
        "1401": ["4602"],
        "1411": ["4635"],
        "1412": ["4636"],
        "1413": ["4637"],
        "1416": ["4638"],
        "1417": ["4639"],
        "1418": ["4640"],
        "1419": ["4640"],
        "1420": ["4640"],
        "1421": ["4641"],
        "1422": ["4642"],
        "1424": ["4643"],
        "1426": ["4644"],
        "1428": ["4645"],
        "1429": ["4646"],
        "1430": ["4647"],
        "1431": ["4647"],
        "1432": ["4647"],
        "1433": ["4647"],
        "1438": ["4648"],
        "1439": ["4602"],
        "1441": ["4649"],
        "1443": ["4649"],
        "1444": ["1577"],
        "1445": ["4650"],
        "1449": ["4651"],
        "1502": ["1506"],
        "1504": ["1507"],
        "1514": ["1514"],
        "1519": ["1577"],
        "1523": ["1507"],
        "1524": ["1578"],
        "1526": ["1578"],
        "1529": ["1507"],
        "1534": ["1507"],
        "1543": ["1506"],
        "1545": ["1506"],
        "1546": ["1507"],
        "1548": ["1579"],
        "1551": ["1579"],
        "1571": ["5055"],
        "1805": ["1806"],
        "1826": ["1826"],
        "1849": ["1875"],
        "1852": ["5412"],
        "1853": ["1853"],
        "1854": ["1806"],
        "1867": ["1867"],
        "1902": ["5401"],
        "1903": ["5402"],
        "1911": ["5411"],
        "1913": ["5412"],
        "1917": ["5413"],
        "1919": ["5414"],
        "1920": ["5415"],
        "1922": ["5416"],
        "1923": ["5417"],
        "1924": ["5418"],
        "1925": ["5419"],
        "1926": ["5420"],
        "1927": ["5421"],
        "1928": ["5421"],
        "1929": ["5421"],
        "1931": ["5421"],
        "1933": ["5422"],
        "1936": ["5423"],
        "1938": ["5424"],
        "1939": ["5425"],
        "1940": ["5426"],
        "1941": ["5427"],
        "1942": ["5428"],
        "1943": ["5429"],
        "2002": ["5404"],
        "2003": ["5405"],
        "2004": ["5406"],
        "2011": ["5430"],
        "2012": ["5403"],
        "2014": ["5432"],
        "2015": ["5433"],
        "2017": ["5406"],
        "2018": ["5434"],
        "2019": ["5435"],
        "2020": ["5436"],
        "2021": ["5437"],
        "2022": ["5438"],
        "2023": ["5439"],
        "2024": ["5440"],
        "2025": ["5441"],
        "2027": ["5442"],
        "2028": ["5443"],
        "2030": ["5444"],
        "5001": ["5001"],
        "5004": ["5006"],
        "5005": ["5007"],
        "5011": ["5055"],
        "5013": ["5056"],
        "5015": ["5057"],
        "5016": ["5059"],
        "5017": ["5057"],
        "5018": ["5058"],
        "5019": ["5058"],
        "5023": ["5059"],
        "5024": ["5059"],
        "5025": ["5025"],
        "5030": ["5001"],
        "5039": ["5006"],
        "5040": ["5007"],
        "5048": ["5007"],
        "5050": ["5060"],
        "5051": ["5060"],
        "1850": ["1806", "1875"],
        "5012": ["5055", "5056", "5059"],
    }
    
    # Function to translate kommune codes
    def translate_kommune_code(b_kommunenr):
        if b_kommunenr in merged_kommunes:
            # If there are multiple translations, return the first one
            return merged_kommunes[b_kommunenr][0]
        else:
            # If no translation is found, return the original code
            return b_kommunenr

    # Apply the translation function to the 'b_kommunenr' column
    df['b_kommunenr'] = df['b_kommunenr'].apply(translate_kommune_code)
    
    return df
