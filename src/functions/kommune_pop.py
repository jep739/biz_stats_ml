import math
import os

import dapla as dp
import pandas as pd
import pyjstat
import requests
from dapla import FileClient
from dapla.auth import AuthClient
from pyjstat import pyjstat

fs = FileClient.get_gcs_file_system()


def fetch_population_data(year):

    import pyjstat
    from pyjstat import pyjstat

    # query ssb API
    
    POST_URL = "https://data.ssb.no/api/v0/no/table/11342/"
    bef_kom = {
        "query": [
            {
                "code": "Region",
                "selection": {
                    "filter": "vs:Kommune",
                    "values": [
                        "3101",
                        "3103",
                        "3105",
                        "3107",
                        "3110",
                        "3112",
                        "3114",
                        "3116",
                        "3118",
                        "3120",
                        "3122",
                        "3124",
                        "3201",
                        "3203",
                        "3205",
                        "3207",
                        "3209",
                        "3212",
                        "3214",
                        "3216",
                        "3218",
                        "3220",
                        "3222",
                        "3224",
                        "3226",
                        "3228",
                        "3230",
                        "3232",
                        "3234",
                        "3236",
                        "3238",
                        "3240",
                        "3242",
                        "3001",
                        "3002",
                        "3003",
                        "3004",
                        "3005",
                        "3006",
                        "3007",
                        "3011",
                        "3012",
                        "3013",
                        "3014",
                        "3015",
                        "3016",
                        "3017",
                        "3018",
                        "3019",
                        "3020",
                        "3021",
                        "3022",
                        "3023",
                        "3024",
                        "3025",
                        "3026",
                        "3027",
                        "3028",
                        "3029",
                        "3030",
                        "3031",
                        "3032",
                        "3033",
                        "3034",
                        "3035",
                        "3036",
                        "3037",
                        "3038",
                        "3039",
                        "3040",
                        "3041",
                        "3042",
                        "3043",
                        "3044",
                        "3045",
                        "3046",
                        "3047",
                        "3048",
                        "3049",
                        "3050",
                        "3051",
                        "3052",
                        "3053",
                        "3054",
                        "0101",
                        "0102",
                        "0103",
                        "0104",
                        "0105",
                        "0106",
                        "0111",
                        "0113",
                        "0114",
                        "0115",
                        "0116",
                        "0117",
                        "0118",
                        "0119",
                        "0121",
                        "0122",
                        "0123",
                        "0124",
                        "0125",
                        "0127",
                        "0128",
                        "0130",
                        "0131",
                        "0133",
                        "0134",
                        "0135",
                        "0136",
                        "0137",
                        "0138",
                        "0199",
                        "0211",
                        "0213",
                        "0214",
                        "0215",
                        "0216",
                        "0217",
                        "0219",
                        "0220",
                        "0221",
                        "0226",
                        "0227",
                        "0228",
                        "0229",
                        "0230",
                        "0231",
                        "0233",
                        "0234",
                        "0235",
                        "0236",
                        "0237",
                        "0238",
                        "0239",
                        "0299",
                        "0601",
                        "0602",
                        "0604",
                        "0605",
                        "0612",
                        "0615",
                        "0616",
                        "0617",
                        "0618",
                        "0619",
                        "0620",
                        "0621",
                        "0622",
                        "0623",
                        "0624",
                        "0625",
                        "0626",
                        "0627",
                        "0628",
                        "0631",
                        "0632",
                        "0633",
                        "0699",
                        "0301",
                        "0399",
                        "3301",
                        "3303",
                        "3305",
                        "3310",
                        "3312",
                        "3314",
                        "3316",
                        "3318",
                        "3320",
                        "3322",
                        "3324",
                        "3326",
                        "3328",
                        "3330",
                        "3332",
                        "3334",
                        "3336",
                        "3338",
                        "3401",
                        "3403",
                        "3405",
                        "3407",
                        "3411",
                        "3412",
                        "3413",
                        "3414",
                        "3415",
                        "3416",
                        "3417",
                        "3418",
                        "3419",
                        "3420",
                        "3421",
                        "3422",
                        "3423",
                        "3424",
                        "3425",
                        "3426",
                        "3427",
                        "3428",
                        "3429",
                        "3430",
                        "3431",
                        "3432",
                        "3433",
                        "3434",
                        "3435",
                        "3436",
                        "3437",
                        "3438",
                        "3439",
                        "3440",
                        "3441",
                        "3442",
                        "3443",
                        "3446",
                        "3447",
                        "3448",
                        "3449",
                        "3450",
                        "3451",
                        "3452",
                        "3453",
                        "3454",
                        "0401",
                        "0402",
                        "0403",
                        "0412",
                        "0414",
                        "0415",
                        "0417",
                        "0418",
                        "0419",
                        "0420",
                        "0423",
                        "0425",
                        "0426",
                        "0427",
                        "0428",
                        "0429",
                        "0430",
                        "0432",
                        "0434",
                        "0435",
                        "0436",
                        "0437",
                        "0438",
                        "0439",
                        "0441",
                        "0499",
                        "0501",
                        "0502",
                        "0511",
                        "0512",
                        "0513",
                        "0514",
                        "0515",
                        "0516",
                        "0517",
                        "0518",
                        "0519",
                        "0520",
                        "0521",
                        "0522",
                        "0528",
                        "0529",
                        "0532",
                        "0533",
                        "0534",
                        "0536",
                        "0538",
                        "0540",
                        "0541",
                        "0542",
                        "0543",
                        "0544",
                        "0545",
                        "0599",
                        "3801",
                        "3802",
                        "3803",
                        "3804",
                        "3805",
                        "3806",
                        "3807",
                        "3808",
                        "3811",
                        "3812",
                        "3813",
                        "3814",
                        "3815",
                        "3816",
                        "3817",
                        "3818",
                        "3819",
                        "3820",
                        "3821",
                        "3822",
                        "3823",
                        "3824",
                        "3825",
                        "3901",
                        "3903",
                        "3905",
                        "3907",
                        "3909",
                        "3911",
                        "4001",
                        "4003",
                        "4005",
                        "4010",
                        "4012",
                        "4014",
                        "4016",
                        "4018",
                        "4020",
                        "4022",
                        "4024",
                        "4026",
                        "4028",
                        "4030",
                        "4032",
                        "4034",
                        "4036",
                        "0701",
                        "0702",
                        "0703",
                        "0704",
                        "0705",
                        "0706",
                        "0707",
                        "0708",
                        "0709",
                        "0710",
                        "0711",
                        "0712",
                        "0713",
                        "0714",
                        "0715",
                        "0716",
                        "0716u",
                        "0717",
                        "0718",
                        "0719",
                        "0720",
                        "0721",
                        "0722",
                        "0723",
                        "0724",
                        "0725",
                        "0726",
                        "0727",
                        "0728",
                        "0729",
                        "0799",
                        "0805",
                        "0806",
                        "0807",
                        "0811",
                        "0814",
                        "0815",
                        "0817",
                        "0819",
                        "0821",
                        "0822",
                        "0826",
                        "0827",
                        "0828",
                        "0829",
                        "0830",
                        "0831",
                        "0833",
                        "0834",
                        "0899",
                        "4201",
                        "4202",
                        "4203",
                        "4204",
                        "4205",
                        "4206",
                        "4207",
                        "4211",
                        "4212",
                        "4213",
                        "4214",
                        "4215",
                        "4216",
                        "4217",
                        "4218",
                        "4219",
                        "4220",
                        "4221",
                        "4222",
                        "4223",
                        "4224",
                        "4225",
                        "4226",
                        "4227",
                        "4228",
                        "0901",
                        "0903",
                        "0904",
                        "0906",
                        "0911",
                        "0912",
                        "0914",
                        "0918",
                        "0919",
                        "0920",
                        "0921",
                        "0922",
                        "0923",
                        "0924",
                        "0926",
                        "0928",
                        "0929",
                        "0932",
                        "0933",
                        "0935",
                        "0937",
                        "0938",
                        "0940",
                        "0941",
                        "0999",
                        "1001",
                        "1002",
                        "1003",
                        "1004",
                        "1014",
                        "1017",
                        "1018",
                        "1021",
                        "1026",
                        "1027",
                        "1029",
                        "1032",
                        "1034",
                        "1037",
                        "1046",
                        "1099",
                        "1101",
                        "1102",
                        "1103",
                        "1106",
                        "1108",
                        "1111",
                        "1112",
                        "1114",
                        "1119",
                        "1120",
                        "1121",
                        "1122",
                        "1124",
                        "1127",
                        "1129",
                        "1130",
                        "1133",
                        "1134",
                        "1135",
                        "1141",
                        "1142",
                        "1144",
                        "1145",
                        "1146",
                        "1149",
                        "1151",
                        "1154",
                        "1159",
                        "1160",
                        "1199",
                        "4601",
                        "4602",
                        "4611",
                        "4612",
                        "4613",
                        "4614",
                        "4615",
                        "4616",
                        "4617",
                        "4618",
                        "4619",
                        "4620",
                        "4621",
                        "4622",
                        "4623",
                        "4624",
                        "4625",
                        "4626",
                        "4627",
                        "4628",
                        "4629",
                        "4630",
                        "4631",
                        "4632",
                        "4633",
                        "4634",
                        "4635",
                        "4636",
                        "4637",
                        "4638",
                        "4639",
                        "4640",
                        "4641",
                        "4642",
                        "4643",
                        "4644",
                        "4645",
                        "4646",
                        "4647",
                        "4648",
                        "4649",
                        "4650",
                        "4651",
                        "1201",
                        "1211",
                        "1214",
                        "1216",
                        "1219",
                        "1221",
                        "1222",
                        "1223",
                        "1224",
                        "1227",
                        "1228",
                        "1230",
                        "1231",
                        "1232",
                        "1233",
                        "1234",
                        "1235",
                        "1238",
                        "1241",
                        "1242",
                        "1243",
                        "1244",
                        "1245",
                        "1246",
                        "1247",
                        "1248",
                        "1249",
                        "1250",
                        "1251",
                        "1252",
                        "1253",
                        "1255",
                        "1256",
                        "1259",
                        "1260",
                        "1263",
                        "1264",
                        "1265",
                        "1266",
                        "1299",
                        "1301",
                        "1401",
                        "1411",
                        "1412",
                        "1413",
                        "1416",
                        "1417",
                        "1418",
                        "1419",
                        "1420",
                        "1421",
                        "1422",
                        "1424",
                        "1426",
                        "1428",
                        "1429",
                        "1430",
                        "1431",
                        "1432",
                        "1433",
                        "1438",
                        "1439",
                        "1441",
                        "1443",
                        "1444",
                        "1445",
                        "1448",
                        "1449",
                        "1499",
                        "1501",
                        "1502",
                        "1503",
                        "1504",
                        "1505",
                        "1506",
                        "1507",
                        "1508",
                        "1511",
                        "1514",
                        "1515",
                        "1516",
                        "1517",
                        "1519",
                        "1520",
                        "1523",
                        "1524",
                        "1525",
                        "1526",
                        "1527",
                        "1528",
                        "1529",
                        "1531",
                        "1532",
                        "1534",
                        "1535",
                        "1539",
                        "1543",
                        "1545",
                        "1546",
                        "1547",
                        "1548",
                        "1551",
                        "1554",
                        "1556",
                        "1557",
                        "1560",
                        "1563",
                        "1566",
                        "1567",
                        "1569",
                        "1571",
                        "1572",
                        "1573",
                        "1576",
                        "1577",
                        "1578",
                        "1579",
                        "1580",
                        "1599",
                        "5001",
                        "5004",
                        "5005",
                        "5006",
                        "5007",
                        "5011",
                        "5012",
                        "5013",
                        "5014",
                        "5015",
                        "5016",
                        "5017",
                        "5018",
                        "5019",
                        "5020",
                        "5021",
                        "5022",
                        "5023",
                        "5024",
                        "5025",
                        "5026",
                        "5027",
                        "5028",
                        "5029",
                        "5030",
                        "5031",
                        "5032",
                        "5033",
                        "5034",
                        "5035",
                        "5036",
                        "5037",
                        "5038",
                        "5039",
                        "5040",
                        "5041",
                        "5042",
                        "5043",
                        "5044",
                        "5045",
                        "5046",
                        "5047",
                        "5048",
                        "5049",
                        "5050",
                        "5051",
                        "5052",
                        "5053",
                        "5054",
                        "5055",
                        "5056",
                        "5057",
                        "5058",
                        "5059",
                        "5060",
                        "5061",
                        "1601",
                        "1612",
                        "1613",
                        "1617",
                        "1620",
                        "1621",
                        "1622",
                        "1624",
                        "1627",
                        "1630",
                        "1632",
                        "1633",
                        "1634",
                        "1635",
                        "1636",
                        "1638",
                        "1640",
                        "1644",
                        "1645",
                        "1648",
                        "1653",
                        "1657",
                        "1662",
                        "1663",
                        "1664",
                        "1665",
                        "1699",
                        "1702",
                        "1703",
                        "1711",
                        "1714",
                        "1717",
                        "1718",
                        "1719",
                        "1721",
                        "1723",
                        "1724",
                        "1725",
                        "1729",
                        "1736",
                        "1738",
                        "1739",
                        "1740",
                        "1742",
                        "1743",
                        "1744",
                        "1748",
                        "1749",
                        "1750",
                        "1751",
                        "1755",
                        "1756",
                        "1799",
                        "1804",
                        "1805",
                        "1806",
                        "1811",
                        "1812",
                        "1813",
                        "1814",
                        "1815",
                        "1816",
                        "1818",
                        "1820",
                        "1822",
                        "1824",
                        "1825",
                        "1826",
                        "1827",
                        "1828",
                        "1832",
                        "1833",
                        "1834",
                        "1835",
                        "1836",
                        "1837",
                        "1838",
                        "1839",
                        "1840",
                        "1841",
                        "1842",
                        "1843",
                        "1845",
                        "1848",
                        "1849",
                        "1850",
                        "1851",
                        "1852",
                        "1853",
                        "1854",
                        "1855",
                        "1856",
                        "1857",
                        "1858",
                        "1859",
                        "1860",
                        "1865",
                        "1866",
                        "1867",
                        "1868",
                        "1870",
                        "1871",
                        "1874",
                        "1875",
                        "1899",
                        "5501",
                        "5503",
                        "5510",
                        "5512",
                        "5514",
                        "5516",
                        "5518",
                        "5520",
                        "5522",
                        "5524",
                        "5526",
                        "5528",
                        "5530",
                        "5532",
                        "5534",
                        "5536",
                        "5538",
                        "5540",
                        "5542",
                        "5544",
                        "5546",
                        "5601",
                        "5603",
                        "5605",
                        "5607",
                        "5610",
                        "5612",
                        "5614",
                        "5616",
                        "5618",
                        "5620",
                        "5622",
                        "5624",
                        "5626",
                        "5628",
                        "5630",
                        "5632",
                        "5634",
                        "5636",
                        "5401",
                        "5402",
                        "5403",
                        "5404",
                        "5405",
                        "5406",
                        "5411",
                        "5412",
                        "5413",
                        "5414",
                        "5415",
                        "5416",
                        "5417",
                        "5418",
                        "5419",
                        "5420",
                        "5421",
                        "5422",
                        "5423",
                        "5424",
                        "5425",
                        "5426",
                        "5427",
                        "5428",
                        "5429",
                        "5430",
                        "5432",
                        "5433",
                        "5434",
                        "5435",
                        "5436",
                        "5437",
                        "5438",
                        "5439",
                        "5440",
                        "5441",
                        "5442",
                        "5443",
                        "5444",
                        "1901",
                        "1902",
                        "1903",
                        "1911",
                        "1913",
                        "1915",
                        "1917",
                        "1919",
                        "1920",
                        "1921",
                        "1922",
                        "1923",
                        "1924",
                        "1925",
                        "1926",
                        "1927",
                        "1928",
                        "1929",
                        "1931",
                        "1933",
                        "1936",
                        "1938",
                        "1939",
                        "1940",
                        "1941",
                        "1942",
                        "1943",
                        "1999",
                        "2001",
                        "2002",
                        "2003",
                        "2004",
                        "2011",
                        "2012",
                        "2014",
                        "2015",
                        "2016",
                        "2017",
                        "2018",
                        "2019",
                        "2020",
                        "2021",
                        "2022",
                        "2023",
                        "2024",
                        "2025",
                        "2027",
                        "2028",
                        "2030",
                        "2099",
                        "2111",
                        "2112",
                        "2115",
                        "2121",
                        "2131",
                        "2199",
                        "2211",
                        "2299",
                        "2300",
                        "2311",
                        "2321",
                        "2399",
                        "2599",
                        "9999",
                    ],
                },
            },
            {
                "code": "ContentsCode",
                "selection": {"filter": "item", "values": ["Folkemengde"]},
            },
            {"code": "Tid", "selection": {"filter": "item", "values": [year]}},
        ],
        "response": {"format": "json-stat2"},
    }

    # Behandler spørringen
    resultat1 = requests.post(POST_URL, json=bef_kom)

    # Check if request was successful
    if resultat1.status_code == 200:
        from pyjstat import pyjstat

        # Convert JSON response to DataFrame
        dataset1 = pyjstat.Dataset.read(resultat1.text)
        df = dataset1.write("dataframe")

        # Add 'region' column based on the values in the query
        regions = bef_kom["query"][0]["selection"]["values"]
        df["kommune_nr"] = regions

        # Reorder columns
        df = df[["region", "value", "år", "kommune_nr"]]

        return df
    else:
        print("Failed to retrieve data:", resultat1.status_code)
        return None


def befolkning_behandling(year, fjor):
    
    import sys
    import numpy as np
    sys.path.append("../functions")
    import kommune_translate

    # Convert year and previous year to integers
    year_int = int(year)
    fjor_int = int(fjor)

    # Fetch population data for the current year and previous year
    df1 = fetch_population_data(year)
    df2 = fetch_population_data(fjor)

    # Filter out rows where 'value' is 0
    df1 = df1[df1["value"] != 0]
    df2 = df2[df2["value"] != 0]

    # Add 'year' column to each dataframe
    df1["year"] = year_int
    df2["year"] = fjor_int

    # Translate municipality codes if the year is less than 2020
    if df1["year"].iloc[0] < 2020:
        df1 = kommune_translate.translate_kommune_kodes(df1)
    if df2["year"].iloc[0] < 2020:
        df2 = kommune_translate.translate_kommune_kodes(df2)

    # Rename the 'value' column to 'befolkning' and 'befolkningx' respectively
    kommune_pop_aar = df1.rename(columns={"value": "befolkning"})
    kommune_pop_fjor = df2.rename(columns={"value": "befolkningx"})

    # Merge the current year and previous year population data on 'kommune_nr'
    kommune_befolk = pd.merge(
        kommune_pop_aar, kommune_pop_fjor, on="kommune_nr", how="inner"
    )

    # Calculate the population delta
    kommune_befolk["befolkning_delta"] = (
        kommune_befolk["befolkning"] / kommune_befolk["befolkningx"]
    )

    # Rename 'kommune_nr' to 'b_kommunenr'
    kommune_befolk = kommune_befolk.rename(columns={"kommune_nr": "b_kommunenr"})

    # Keep only 'b_kommunenr' and 'befolkning_delta' columns
    kommune_befolk = kommune_befolk[["b_kommunenr", "befolkning_delta"]]

    # Replace infinite values in 'befolkning_delta' with NaN
    kommune_befolk["befolkning_delta"].replace([np.inf, -np.inf], np.nan, inplace=True)

    # Calculate the mean value of 'befolkning_delta'
    mean_value = kommune_befolk["befolkning_delta"].mean()

    # Fill NaN values in 'befolkning_delta' with the mean value
    kommune_befolk["befolkning_delta"].fillna(mean_value, inplace=True)

    return kommune_befolk

